
<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html>
<head>
<style type="text/css">

.square {
 background-color:white;
 font-size:1cm;
 width: 2cm;
 height: 2cm;
 vertical-align: center;
 text-align: center;
}
.blue {
    color: blue;
    font-size: 24px;
}
.green {
    color: green;
    font-size: 24px;
}
.red {
    color : red;
    font-size: 24px;
}

.grid {
 border: black;
 background-color:black;
}
#left_panel {
    border: black solid;
    text-align: center;
    width: 350px;
    float: right
}
#control {
    border: black solid;
    text-align: center;
    width: 350px;
}
#lobby {
    border: black solid;
    text-align: center;
    width: 350px;
}
.lobby_player {
    text-align: center;
    border: outset;
    width: inherit;
}
.table_row {
    float : left;
    width: 100%;
}
.table_div {
    float : left;
    width: 30%;
    padding: 10px;
}

</style>

<title>Tic-Tac-Toe</title>
<script src="../pubnub.js"></script>
<script src="./ttt.js"></script>
<script type="text/javascript">
var pubnub = PUBNUB({
    publish_key   : "pub-c-fd1a1d00-6c07-4435-a647-495cdfcdfc95",
    subscribe_key : "sub-c-f045aeaa-befe-11e3-b6e0-02ee2ddab7fe",
    uuid : get_uid(),
    leave_on_unload : true
});
var current_game_count = 0;
</script>
<script src="http://code.jquery.com/jquery-1.11.0.min.js"></script>
<script type="text/javascript" language=javascript>


var message_count = 0;
var games = {}
var lobby = []
var display_table_id_next = 1;
var max_per_row_tables = 3;
var max_total = 6;
var clear_after = get_clear_after();
var game_count = 0;
function get_my_num(game_id) {
    return games[game_id]['num'];
}

function get_opponent_num(game_id) {
    return ((games[game_id]['num'] == 1)?2:1);
}

function start_handshake(uuid, turn) {
    if (current_game_count >= get_max_concurrent()) return;
    var message = {
        'game' : 'tictactoe',
        'mtype' : 'handshake',
        'step' : 1,
        'p1_uuid' : pubnub.get_uuid(),
        'p2_uuid' : uuid,
        'turn' : turn
    };
    message['sender'] = pubnub.get_uuid();
    message['id'] = ++message_count; 

    function p(m) {
        pubnub.publish({
            'channel' : get_lobby_channel(),
            'message' : message,
            'callback' : function(r){debug_log('HANDSHAKE 1 SENT : ' + JSON.stringify(message));},
            'error' : function(r){debug_log('ERROR in publish ' + JSON.stringify(r) + ', ' + JSON.stringify(message)); p(m);}
        })
    }
    p(message);
}
function start_handshake_2(uuid, turn) {
    if (current_game_count >= get_max_concurrent()) return;
    var message = {
        'game' : 'tictactoe',
        'mtype' : 'handshake',
        'step' : 2,
        'p1_uuid' : uuid,
        'turn' : turn,
        'p2_uuid' : pubnub.get_uuid(),
        'game_id' : getRandomInt(1,10000000000),
        'symbol' : get_symbol(2)
    };
    message['sender'] = pubnub.get_uuid();
    message['id'] = ++message_count; 
    function p(m) {
        pubnub.publish({
            'channel' : get_lobby_channel(),
            'message' : message,
            'callback' : function(r){debug_log('HANDSHAKE 2 SENT : ' + JSON.stringify(message));},
            'error' : function(r){debug_log('ERROR in publish ' + JSON.stringify(r) + ', ' + JSON.stringify(message)); p(m);}
        })
    }
    p(message);
}
function start_handshake_3(uuid, turn, game_id) {
    var message = {
        'game' : 'tictactoe',
        'mtype' : 'handshake',
        'step' : 3,
        'p1_uuid' : pubnub.get_uuid(),
        'p2_uuid' : uuid,
        'turn' : turn,
        'game_id' : game_id,
        'symbol' : get_symbol(1)
    };
    message['sender'] = pubnub.get_uuid();
    message['id'] = ++message_count; 

    function p(m) {
        pubnub.publish({
            'channel' : get_lobby_channel(),
            'message' : message,
            'callback' : function(r){debug_log('HANDSHAKE 3 SENT : ' + JSON.stringify(message));},
            'error' : function(r){debug_log('ERROR in publish ' + JSON.stringify(r) + ', ' + JSON.stringify(message)); p(m);}
        })
    }
    p(message);
}

function clear_timers(game_id, time_remaining) {
    var game = games[game_id];
    if (game) {
        clearInterval(game['interval']);
        clearTimeout(game['timeout']);
        game['time_remaining'] = (time_remaining != 'undefined')?time_remaining:60;
    }
}

function update_time_remaining(game_id, n) {
    $("#" + game_id + " #time").html('<p>' + n + ' sec remaining</p>');
}

function update_turn(game_id, uuid) {

    var game = games[game_id];
    if (game) {

        $("#" + game_id + " #turn").html('<p>' + ((uuid == pubnub.get_uuid())?"Your ":"Opponent\'s") + ' turn</p>');

        $("#" + game_id + " #turn").removeClass((uuid == pubnub.get_uuid())?"red":"green");
        $("#" + game_id + " #turn").addClass((uuid == pubnub.get_uuid())?"green":"red");

        clear_timers(game_id);
        
        if (uuid == pubnub.get_uuid()) {
            if (is_auto_play()) {
                game_step(game_id,
                    get_next_move(game['map'], get_my_num(game_id), get_opponent_num(game_id)));
                return;
            }

            game['timeout'] = setTimeout(function(){
                declare_winner(game_id, get_opponent_num(game_id));
                //end_game(game_id, game['uuid']);
                clear_timers(game_id);
            }, 60000)

            game['interval'] = setInterval(function() {
                update_time_remaining(game_id, game['time_remaining']);
                game['time_remaining']--;
            }, 1000);

        } else {
            $("#" + game_id + " #time").html('');
        }
    }
}



function update_result(game_id, result) {
    clear_timers(game_id);
    $("#" + game_id + " #turn").empty();
    $("#" + game_id + " #result").html('<p>' + result + '</p>');
    var color = "blue";
    if (result == "You won") {
        color = "green";
    } else if (result == "You lost") {
        color = "red";
    }
    $("#" + game_id + " #result").addClass(color);
}

function update_my_uuid(game_id, uuid) {
    $("#" + game_id + " #my_uuid").html('<p> My UUID: ' + uuid + '</p>');
}

function update_opponent(game_id, uuid) {
    $("#" + game_id + " #opponent_uuid").html('<p> Opponent UUID: ' + uuid + '</p>');
}

function get_print_symbol(game_id, s) {
    if (s == 0) {
        return '';
    }
    if (s == get_my_num(game_id)) {
        return games[game_id]['symbol'];
    } 
    if (s == get_opponent_num(game_id)) {
        return games[game_id]['opponent_symbol'];
    } 
}
function update_game_status(game_id, status) {
    $("#" + game_id + " #game").html('<p>' + status + '</p>');
}

function draw_grid(game_id, symbol, map) {
    for (var i in map) {
        $("#tbl-" + game_id + " #" + i).html(get_print_symbol(game_id, map[i]));
        
        if (symbol == map[i]) {
            $("#tbl-" + game_id + " #" + i).removeClass("red");
            $("#tbl-" + game_id + " #" + i).addClass("green");
        } else {
            $("#tbl-" + game_id + " #" + i).removeClass("green");
            $("#tbl-" + game_id + " #" + i).addClass("red");
        }
    }
}



function declare_winner(game_id, symbol) {
    var winner = '';
    var game = games[game_id];

    if (game) {
        if (symbol == get_my_num(game_id)) {
            winner = pubnub.get_uuid();
        } else if (symbol != 0){
            winner = game['uuid'];
        } else {
            winner = '';
        }
        var message = {
            'mtype' : 'winner',
            'game_id' : game_id,
            'winner' : winner
        }
        message['sender'] = pubnub.get_uuid();
        message['id'] = ++message_count;
        function p(m) {
            pubnub.publish({
                'channel' : game_id,
                'message' : message,
                'callback' : function(r){'DECLARED WINNER : ' + debug_log(JSON.stringify(message))},
                'error' : function(r){debug_log('ERROR in publish ' + JSON.stringify(r) + ', ' + JSON.stringify(message)); p(m);}
            })
        }
        p(message);
    }
}

function handle_game_messages(message) {

    if (message['mtype'] == 'game') {

        var gid_in_message = message['game_id'];
        var game = games[gid_in_message];
        debug_log('RECEIVED GAME MESSAGE [' + gid_in_message + '] : ' + JSON.stringify(message));
        if (game) {
            game['map'] = message['map'];

            draw_grid(gid_in_message, get_my_num(gid_in_message) , game['map']);

            game['turn'] = message['turn'];
            
            var winning_symbol = check_winner(game['map']);

            if (winning_symbol) {
                declare_winner(gid_in_message, winning_symbol);
            } else {
                if (is_draw(game['map'])) {
                    declare_winner(gid_in_message, '');
                } else {
                    update_turn(gid_in_message, game['turn']);
                }
            }
        }
        
    }
    if (message['mtype'] == 'winner') {
        if (games[message['game_id']]) {
            end_game(message['game_id'], message['winner']);
        }
    }

}

function get_game_id_from_cell(node) {
    return node.parentNode.parentNode.parentNode.parentNode.parentNode.id;
}


function select_cell(cell) {
    game_step(get_game_id_from_cell(cell), cell.id);
}

function create_grid(game_id) {
    game_count++;
    if (game_count % clear_after == 0) {
        game_count = 0;
        $("#table_row").empty();
    }
    var game_table = 
                '<table id=tbl-' + game_id + ' align=center class=grid cellspacing=2>'          +
                    '<tr>'                                                                      +
                         '<td class=square id=0 onclick="select_cell(this);"></td>'             +
                         '<td class=square id=1 onclick="select_cell(this);"></td>'             +
                         '<td class=square id=2 onclick="select_cell(this);"></td>'             +
                    '</tr>'                                                                     +
                    '<tr>'                                                                      +
                         '<td class=square id=3 onclick="select_cell(this);"></td>'             +
                         '<td class=square id=4 onclick="select_cell(this);"></td>'             +
                         '<td class=square id=5 onclick="select_cell(this);"></td>'             +
                    '</tr>'                                                                     +
                    '<tr>'                                                                      +
                         '<td class=square id=6 onclick="select_cell(this);"></td>'             +
                         '<td class=square id=7 onclick="select_cell(this);"></td>'             +
                         '<td class=square id=8 onclick="select_cell(this);"></td>'             +
                    '</tr>'                                                                     +
                '</table>'  ;                                                                  
    
    var grid_html =         
    '<tr id=' + game_id + '>'                                                                   +
            '<td>'                                                                              +
                game_table                                                                      +
            '</td>'                                                                             +
            '<td>'                                                                              +
                '<div id="game"></div>'                                                         +
                '<div id="my_uuid"></div>'                                                      +
                '<div id="opponent_uuid"></div>'                                                +
                '<div id="turn"></div>'                                                         +
                '<div id="time"></div>'                                                         +
                '<div id="result"></div>'                                                       +
            '</td>'                                                                             +
        '</tr>'   ;


    if (!is_display_mode()) {
         $("#main").prepend("<tr></tr>");
         $("#main").prepend(grid_html);
    } else {

        $("#table_row").prepend("<div class=table_div></div>");
        $("#table_row div:first").append(game_table);
    }
}


function create_game(game_id, opponent_uuid, my_symbol, turn_uuid, num, opponent_symbol) {
    games[game_id] = {
        'map'               : [0,0,0,0,0,0,0,0,0],
        'uuid'              : opponent_uuid,
        'symbol'            : my_symbol,
        'turn'              : turn_uuid,
        'timeout'           : null,
        'interval'          : null,
        'time_remaining'    : 60,
        'num'               : num,
        'opponent_symbol'   : opponent_symbol
    };
    debug_log('CREATING GAME : [' + game_id + ']' + JSON.stringify(games[game_id]));
    create_grid(game_id);
    update_opponent(game_id, opponent_uuid);
    update_my_uuid(game_id, pubnub.get_uuid());
    update_game_status(game_id, 'Game Started');
    update_turn(game_id, turn_uuid);
    current_game_count++;

}

function end_game(game_id, winner_uuid) {

    $("#" + game_id + " #time").html('');
    update_game_status(game_id, 'finished');

    if (winner_uuid == pubnub.get_uuid()) {
        update_result(game_id, "You won");
    } else if (winner_uuid == '') {
        update_result(game_id, "Draw");
    } else {
        update_result(game_id, "You lost");
    }
    debug_log('END GAME : [' + game_id + ']' + JSON.stringify(games[game_id]));
    delete games[game_id];
    current_game_count--;
    if (is_auto_join()) {
        var i = getRandomInt(0, lobby.length - 1);
        start_handshake(lobby[i], lobby[i]);
    }
}

function enter_lobby() {
    pubnub.subscribe({
        'restore' : true,
        'channel' : get_lobby_channel(),
        'callback' : function(r) {

            /* read message only if we are either player 1 or player 2 */

            if (r['game'] == 'tictactoe' && 
                (r['p1_uuid'] == pubnub.get_uuid() || 
                r['p2_uuid'] == pubnub.get_uuid())) {
                    debug_log('HANDSHAKE ' + r['step'] + ' RECEIVED : ' + JSON.stringify(r));
                    // handle handshakes
                    if (r['mtype'] == 'handshake') {
                        switch(r['step']) {

                            case 1: // some one has asked us to play

                                if (r['p2_uuid'] == pubnub.get_uuid()) { // we are player 2, send handshake
                                    start_handshake_2(r['p1_uuid'], r['turn']);
                                }   
                                break;

                            case 2: // some has responded to our play request
                                if (r['p1_uuid'] == pubnub.get_uuid()) { // we are player 1, we send initial request

                                    // leave lobby. we might want to remove this in case playing multiple games
                                    // at same time is going to be supported later on.
                                    //pubnub.unsubscribe({channel : get_lobby_channel()}); 
                                    
                                    // create a private channel to play the game.
                                    pubnub.subscribe({
                                        'restore' : true,
                                        'channel' : r['game_id'],
                                        'callback' : function(r1) {
                                            handle_game_messages(r1);
                                        },
                                        'error' : function(r1) {

                                        },
                                        'connect' : function(r1) {

                                            // send handshake 3 to acknowledge that we are starting

                                            start_handshake_3(r['p2_uuid'], r['turn'], r['game_id']);
                                    
                                            create_game(r['game_id'], r['p2_uuid'], get_symbol(1), r['turn'], 1, r['symbol']);

                                        }
                                    });
                                }
                                break;

                            case 3: // some one has confirmed the game

                                if (r['p2_uuid'] == pubnub.get_uuid()) { // we are player 2, player 1 has confirmed 

                                    // leave lobby. we might want to remove this in case playing multiple games
                                    // at same time is going to be supported later on.                                    
                                    //pubnub.unsubscribe({channel : get_lobby_channel()});

                                    pubnub.subscribe({
                                        'restore' : true,
                                        'channel' : r['game_id'],
                                        'callback' : function(r1) {
                                            handle_game_messages(r1);
                                        },
                                        'error' : function(r1) {

                                        },
                                        'connect' : function(r1) {

                                            create_game(r['game_id'], r['p1_uuid'], get_symbol(2), r['turn'], 2, r['symbol']);

                                        }
                                    });
                                }
                                break;
                        }
                    }

            }
        },
        'error' : function(r) {

        },
        connect : function(r) {
            if (is_auto_join()) {
                var i = getRandomInt(0, lobby.length - 1);
                if (lobby[i] && lobby[i] != pubnub.get_uuid()) start_handshake(lobby[i], lobby[i]);
            }
            /*
            pubnub.here_now({
                'channel' : get_lobby_channel(),
                'callback' : function(r) {
                    var uuids = r.uuids;

                    
                    var i = getRandomInt(0,uuids.length - 1);
                    var count = 0;
                    while(uuids[i] != pubnub.get_uuid() && uuids.length > 1 && count < 4) {
                        i = getRandomInt(0, uuids.length - 1);
                        count++;
                    }
                    start_handshake(uuids[i], uuids[i]);
                    
                    lobby = []
                    for ( var i in uuids) {
                        add_to_lobby(uuids[i]);
                    }
                    draw_lobby(lobby);
                },
                'error' : function (r) {

                }
            });
            */

            
        },
        presence : function(r) {
              /*$("#lobby table").append('<tr><td onclick="start_handshake(this.innerHTML, this.innerHTML);">'+r.uuid+'</td></tr>') */
            
            if (r.action == 'join' && r.uuid != pubnub.get_uuid()) {
                update_lobby(r.uuid);
                //start_handshake(r.uuid , r.uuid);
            }
            if ((r.action == 'leave' || r.action == 'timeout') && r.uuid != pubnub.get_uuid()) {
                for ( var i in lobby) {
                    if (r.uuid == lobby[i]) {
                        lobby[i] = 0;
                        draw_lobby(lobby);
                    }
                }
                
                //start_handshake(r.uuid , r.uuid);
            }
            
        }
    });
}

function add_to_lobby(uuid) {
    for (var i in lobby) {
        if (lobby[i] == uuid) {
            return;
        }
    }
    lobby.push(uuid); 
}

function update_lobby(uuid) {
    add_to_lobby(uuid);
    draw_lobby(lobby);
}


function game_step(game_id, position) {

    var game = games[game_id];
    if (game) {
        if (game['map'][position] == 0 && game['turn'] == pubnub.get_uuid()) {
            
            var m = [];

            for ( var i in game['map']) {
                m[i] = game['map'][i];
            }

            m[position] = get_my_num(game_id);
            var message = {
                'mtype' : 'game',
                'game_id' : game_id,
                'map' : m,
                'turn' : game['uuid']
            }
            message['sender'] = pubnub.get_uuid();
            message['id'] = ++message_count; 

            function p(m) {
                pubnub.publish({
                    'channel' : game_id,
                    'message' : message,
                    'callback' : function(r){try {game['map'][position] = get_my_num(game_id);} catch (e) {}debug_log('SENT GAME STEP ['+ game_id +'] : ' + JSON.stringify(message))},
                    'error' : function(r){debug_log('ERROR in publish ' + JSON.stringify(r) + ', ' + JSON.stringify(message)); p(m);}
                })
            }
            p(message);
        }
    }
}

function draw_lobby(uuids) {
    var arrayLength = parseInt(uuids.length);
    $("#lobby #list").html('');
    for (i=0; i<arrayLength; i++) {
        if (uuids[i] != pubnub.get_uuid() && uuids[i] != 0) {
            $("#lobby #list").append('<div><button style="height:20px;width:90%;margin:5px" type=button onclick="start_handshake(this.innerHTML, this.innerHTML);">'+uuids[i]+'</button></div>');
        }
    }
}

function clear_screen() {
    $("#main").html('');
}

function populate_lobby() {
    get_player_list(function(r){
            var array = r.uuids;
            for (var i in array) {
                add_to_lobby(array[i]);   
            }
            draw_lobby(lobby);
            enter_lobby();
    })
}
Object.size = function(obj) {
    var size = 0, key;
    for (key in obj) {
        if (obj.hasOwnProperty(key)) size++;
    }
    return size;
};
function start() {
    $("#lobby_name").val(get_lobby_channel());
    $("#uid").val(get_uid());
    $("#label").val(get_symbol());
    $("#clear_after").val(get_clear_after());
    $("#max").val(get_max_concurrent());
    $("#display_mode").checked = is_display_mode();
    $("#auto_play").prop('checked', is_auto_play());
    $("#auto_join").prop('checked', is_auto_join());

    if (is_display_mode()) {
        $("#display_off").remove();
        enter_lobby(); 
    } else {
        $("#display_on").remove();
        populate_lobby();
    }

    setInterval(function() {
       debug_log('No. of games in progress : ' + Object.size(games));
    }, 5000);
}

function reload_game() {
    var url = window.location.href;    
    display_mode = $("#display_mode").prop('checked');
    auto_join = $("#auto_join").prop('checked');
    auto_play = $("#auto_play").prop('checked');
    uid = $("#uid").val() || get_uid();
    symbol = $("#label").val() || get_symbol();
    lobby = $("#lobby_name").val() || get_lobby_channel();
    max = $("#max").val() || get_max_concurrent();
    clearafter = $("#clear_after").val() || get_clear_after();

    url = url.split("?")[0];
    url += "?";

    url += 'lobby='
    url += lobby;

    url += '&autoplay=';
    url += auto_play;


    url += '&display=';
    url += display_mode;

    url += '&autojoin=';
    url += auto_join;

    url += '&max=';
    url += max;

    url += '&symbol='
    url += symbol;

    url += '&clearafter='
    url += clearafter;


    window.location.href = url;
}

</script>

</head>
<body onload="start()">
<div id=display_off>

    <div style="float:left">
        <table id="main">
        </table>
    </div>

    <div id=left_panel>
        <div id=control>
            <div>
            <table style="margin:15px">
                  <tr>
                    <td>Lobby Name</td>
                    <td>
                      <input type="text" id="lobby_name" size="35">
                    </td>
                  </tr>
                  <tr>
                    <td>UID</td>
                    <td>
                      <input type="text" id="uid" size="35">
                    </td>
                  </tr>
                  <tr>
                    <td>Label</td>
                    <td>
                      <input type="text" id="label" size="35">
                    </td>
                  </tr>
                  <tr>
                    <td>Max Concurrent Games</td>
                    <td>
                      <input type="text" id="max" size="35" value=1>
                    </td>
                  </tr>
                  <tr>
                    <td>Clear After</td>
                    <td>
                      <input type="text" id="clear_after" size="35" value=12>
                    </td>
                  </tr>
                  <tr>
                    <td>Auto Play ?</td>
                    <td><input type="checkbox" id="auto_play" ></td>
                  </tr>
                  <tr>
                    <td>Auto Join ?</td>
                    <td><input type="checkbox" id="auto_join" ></td>
                  </tr>
                  <tr>
                    <td>Display Mode ?</td>
                    <td><input type="checkbox" id="display_mode" ></td>
                  </tr>
                </table>

                <button style="height:20px; width:90%;margin:5px" type=button onclick="reload_game()">
                    Reload
                </button>

                <button style="height:20px; width:90%;margin:5px" type=button onclick="clear_screen()">
                    Clear Screen
                </button>
            </div>
        </div>

        <div id=lobby>
            <p>LOBBY<p>
            <div id=list></div>
        </div>
    </div>

</div>
<div id=display_on>
    <div id=table_row class=row>
    </div>
</div>


</body>
</html>
