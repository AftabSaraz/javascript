
<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html>
<head>
<title>Tic-Tac-Toe</title>
<script src="../pubnub.js"></script>
<script src="http://code.jquery.com/jquery-1.11.0.min.js"></script>.
<script type="text/javascript" language=javascript>

var lobby_channel = 'lobby1'

var pubnub = PUBNUB({
    publish_key   : "pub-c-fd1a1d00-6c07-4435-a647-495cdfcdfc95",
    subscribe_key : "sub-c-f045aeaa-befe-11e3-b6e0-02ee2ddab7fe",
    uuid : PUBNUB.uuid(),
    leave_on_unload : true
});

var games = {}
var game_no = '';

function is_uuid_in_lobby(uuid, callback, error) {
    pubnub.where_now({
        'uuid'     : uuid,
        'callback' : function(r) {
             callback((r['channels'].indexOf(lobby_channel) == -1)?false:true);
        },
        'error'    : function(r) {

        }
    });
}

function get_player_list(callback){
    pubnub.here_now({
        'channel' : lobby_channel,
        'callback' : callback
    })
}

function start_handshake(uuid, turn) {
    var message = {
        'game' : 'tictactoe',
        'mtype' : 'handshake',
        'step' : 1,
        'p1_uuid' : pubnub.get_uuid(),
        'p2_uuid' : uuid,
        'turn' : turn
    };

    pubnub.publish({
        'channel' : lobby_channel,
        'message' : message,
        'callback' : function(r) {console.log(r)},
        'error' : function(r) {console.log(r)}  
    });
}
function start_handshake_2(uuid, turn) {
    var message = {
        'game' : 'tictactoe',
        'mtype' : 'handshake',
        'step' : 2,
        'p1_uuid' : uuid,
        'turn' : turn,
        'p2_uuid' : pubnub.get_uuid(),
        'game_id' : Math.random()
    };

    pubnub.publish({
        'channel' : lobby_channel,
        'message' : message,
        'callback' : function(r) {console.log(r)},
        'error' : function(r) {console.log(r)}   
    });
}
function start_handshake_3(uuid, turn, game_id) {
    var message = {
        'game' : 'tictactoe',
        'mtype' : 'handshake',
        'step' : 3,
        'p1_uuid' : pubnub.get_uuid(),
        'p2_uuid' : uuid,
        'turn' : turn,
        'game_id' : game_id
    };

    pubnub.publish({
        'channel' : lobby_channel,
        'message' : message,
        'callback' : function(r) {console.log(r)},
        'error' : function(r) {console.log(r)}  
    });
}

function update_turn(uuid) {
    $("#turn").empty();
    $("#turn").append('<p>' + uuid + ' turn</p>');
}

function draw_grid(map) {
    for (var i in map) {
        document.getElementById(i).innerHTML = map[i];
    }
}

function check_winner(map) {
    if (map[0] != '') {
        if (map[0] == map[1] && map[0] == map[2]) {
            return map[0];
        }
        if (map[0] == map[4] && map[0] == map[8]) {
            return map[0];
        }
        if (map[0] == map[3] && map[0] == map[6]) {
            return map[0];
        }
    }
    if (map[3] != '') {
        if (map[3] == map[4] && map[3] == map[5]) {
            return map[3];
        }
    }
    if (map[6] != '') {
        if (map[6] == map[7] && map[6] == map[8]) {
            return map[6];
        }
        if (map[6] == map[4] && map[6] == map[2]) {
            return map[6];
        }
    }
    if (map[1] != '') {
        if (map[1] == map[4] && map[1] == map[7]) {
            return map[1];
        }
    }
    if (map[2] != '') {
        if (map[2] == map[5] && map[2] == map[8]) {
            return map[2];
        }
    }
    return null;
}

function declare_winner(symbol) {
    var winner = '';
    if (symbol == games[game_no].symbol) {
        // I am the winner
        //alert("Congrats you won");
        winner = pubnub.get_uuid();
    } else {
        //alert("You lost");
        winner = games[game_no].uuid;
    }
    var message = {
        'mtype' : 'winner',
        'game_id' : game_no,
        'winner' : winner
    }
    pubnub.publish({
        'channel' : game_no,
        'message' : message,
        'callback' : function(r){console.log(JSON.stringify(r))},
        'error' : function(r){console.log(JSON.stringify(r))}
    })
}

function handle_game_messages(message) {
    if (message['mtype'] == 'game') {
        games[message['game_id']].map = message.map;
        draw_grid(games[message['game_id']].map);
        games[game_no]['turn'] = message['turn'];
        update_turn(games[game_no]['turn']);
        var winning_symbol = check_winner(games[message['game_id']].map);
        if (winning_symbol) {
            declare_winner(winning_symbol);
        }
        
    }
    if (message['mtype'] == 'winner') {
        if (message['winner'] == pubnub.get_uuid()) {
            alert("You won");
        } else {
            alert("You lost");
        }
    }

}


function enter_lobby() {
    pubnub.subscribe({
        'channel' : lobby_channel,
        'callback' : function(r) {console.log(JSON.stringify(r));
            if (r['game'] == 'tictactoe' && 
                (r['p1_uuid'] == pubnub.get_uuid() || 
                r['p2_uuid'] == pubnub.get_uuid())) {

                    if (r['mtype'] == 'handshake') {
                        switch(r['step']) {

                            case 1: // some one has asked us to play

                                if (r['p2_uuid'] == pubnub.get_uuid()) {
                                    var ok = confirm(r.p1_uuid + ' has requested to play with you. Are you game ?');
                                    if (ok) {
                                        start_handshake_2(r['p1_uuid'], r['turn']);
                                    }
                                }   
                                break;
                            case 2: // some has responded to our play request
                                if (r['p1_uuid'] == pubnub.get_uuid()) {
                                    game_no = r.game_id;
                                    
                                    games[r['game_id']] = {'map' : ['','','','','','','','',''], 'uuid' : r['p2_uuid'], 'symbol' : 'X', 'turn' : r['turn']}

                                    console.log(JSON.stringify(games));
                                    
                                    pubnub.subscribe({
                                        'channel' : r.game_id,
                                        'callback' : function(r1) {
                                            handle_game_messages(r1);
                                        },
                                        'error' : function(r1) {

                                        },
                                        'connect' : function(r1) {
                                            alert(r.p2_uuid + ' accepted your request. GAME STARTED. Game ID : ' + r.game_id);
                                            update_turn(r['turn']);
                                            start_handshake_3(r['p2_uuid'], r['turn'], r['game_id']);
                                        }
                                    });
                                }
                                break;
                            case 3: // some one has confirmed the game
                                if (r['p2_uuid'] == pubnub.get_uuid()) {
                                    game_no = r.game_id;
                                    games[r['game_id']] = {'map' : ['','','','','','','','',''], 'uuid' : r['p1_uuid'], 'symbol' : 'O', 'turn' : r.turn}
                                    pubnub.subscribe({
                                        'channel' : r.game_id,
                                        'callback' : function(r1) {
                                            handle_game_messages(r1);
                                        },
                                        'error' : function(r1) {

                                        },
                                        'connect' : function(r1) {
                                            alert('GAME Confirmed with ' + r.p1_uuid + ' . Game ID : ' + r.game_id);
                                            update_turn(r['turn']);
                                        }
                                    });
                                }
                                break;
                        }
                    }

            }
        },
        'error' : function(r) {

        },
        connect : function(r) {
            
        },
        presence : function(r) {
              /*$("#lobby table").append('<tr><td onclick="start_handshake(this.innerHTML, this.innerHTML);">'+r.uuid+'</td></tr>') */
              populate_lobby();
        }
    });
}

function game_step(position) {
    console.log(position);
    if (games[game_no].map[position] == '' && games[game_no]['turn'] == pubnub.get_uuid()) {
        document.getElementById(position).innerHTML = 'X';
        var m = [];
        for ( var i in games[game_no].map) {
            m[i] = games[game_no].map[i];
        }
        m[position] = games[game_no].symbol;
        var message = {
            'mtype' : 'game',
            'game_id' : game_no,
            'map' : m,
            'turn' : games[game_no].uuid
        }
        pubnub.publish({
            'channel' : game_no,
            'message' : message,
            'callback' : function(r){games[game_no].map[position] = 'X';console.log(JSON.stringify(r))},
            'error' : function(r){console.log(JSON.stringify(r))}
        })
    }
}

function select_square(n) {
    console.log(n);

    game_step(n);
}

function populate_lobby() {
    get_player_list(function(r){
            console.log(r);
            var array = r.uuids;
            var arrayLength = parseInt(array.length);
            $("#lobby table").empty();
            for (i=0; i<arrayLength; i++) {
                if (array[i] != pubnub.get_uuid()) {
                    $("#lobby table").append('<tr><td onclick="start_handshake(this.innerHTML, this.innerHTML);">'+array[i]+'</td></tr>');
                }
            }
            enter_lobby();
    })
}
function start() {
    $("#myuuid").append('<p> My UUID: ' + pubnub.get_uuid() + '</p>');
    populate_lobby();
}

</script>
<style type="text/css">

.square {
 background-color:white;
 font-size:1cm;
 width: 2cm;
 height: 2cm;
 vertical-align: center;
 text-align: center;
}


.grid {
 border: black;
 background-color:black;
}

</style>

</head>
<body onload="start()">
<table>
<tr>
    <td>
    <table align=center class=grid cellspacing=2>
    <tr>
     <td class=square id=0 onclick="select_square(this.id);"></td>
     <td class=square id=1 onclick="select_square(this.id);"></td>
     <td class=square id=2 onclick="select_square(this.id);"></td>
    </tr><tr>
     <td class=square id=3 onclick="select_square(this.id);"></td>
     <td class=square id=4 onclick="select_square(this.id);"></td>
     <td class=square id=5 onclick="select_square(this.id);"></td>
    </tr><tr>
     <td class=square id=6 onclick="select_square(this.id);"></td>
     <td class=square id=7 onclick="select_square(this.id);"></td>
     <td class=square id=8 onclick="select_square(this.id);"></td>
    </tr>
    </table>
    </td>
    <td>
    <div id='myuuid'></div>
    <div id='turn'></div>
    <div id="lobby">
        <p>LOBBY</p>
        <table align=center cellspacing=2>
        </table>
    </div>
    </td>
</tr>
</table>
</body>
</html>
