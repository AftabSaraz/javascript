
<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html>
<head>
<title>Tic-Tac-Toe</title>
<script src="../pubnub.js"></script>
<script src="http://code.jquery.com/jquery-1.11.0.min.js"></script>.
<script type="text/javascript" language=javascript>

var lobby_channel = 'lobby1'

var pubnub = PUBNUB({
    publish_key   : "pub-c-fd1a1d00-6c07-4435-a647-495cdfcdfc95",
    subscribe_key : "sub-c-f045aeaa-befe-11e3-b6e0-02ee2ddab7fe",
    uuid : PUBNUB.uuid(),
    leave_on_unload : true
});

var games = {}

function is_uuid_in_lobby(uuid, callback, error) {
    pubnub.where_now({
        'uuid'     : uuid,
        'callback' : function(r) {
             callback((r['channels'].indexOf(lobby_channel) == -1)?false:true);
        },
        'error'    : function(r) {

        }
    });
}

function get_player_list(callback){
    pubnub.here_now({
        'channel' : lobby_channel,
        'callback' : callback
    })
}

function start_handshake(uuid, turn) {
    var message = {
        'game' : 'tictactoe',
        'mtype' : 'handshake',
        'step' : 1,
        'p1_uuid' : pubnub.get_uuid(),
        'p2_uuid' : uuid,
        'turn' : turn
    };

    pubnub.publish({
        'channel' : lobby_channel,
        'message' : message,
        'callback' : function(r) {console.log(r)},
        'error' : function(r) {console.log(r)}  
    });
}
function start_handshake_2(uuid, turn) {
    var message = {
        'game' : 'tictactoe',
        'mtype' : 'handshake',
        'step' : 2,
        'p1_uuid' : uuid,
        'p2_uuid' : pubnub.get_uuid(),
        'game_id' : Math.random()
    };

    pubnub.publish({
        'channel' : lobby_channel,
        'message' : message,
        'callback' : function(r) {console.log(r)},
        'error' : function(r) {console.log(r)}   
    });
}
function start_handshake_3(uuid, turn) {
    var message = {
        'game' : 'tictactoe',
        'mtype' : 'handshake',
        'step' : 3,
        'p1_uuid' : pubnub.get_uuid(),
        'p2_uuid' : uuid,
        'turn' : turn,
        'game_id' : Math.random()
    };

    pubnub.publish({
        'channel' : lobby_channel,
        'message' : message,
        'callback' : function(r) {console.log(r)},
        'error' : function(r) {console.log(r)}  
    });
}

function enter_lobby() {
    pubnub.subscribe({
        'channel' : lobby_channel,
        'callback' : function(r) {console.log(JSON.stringify(r));
            if (r['game'] == 'tictactoe' && 
                (r['p1_uuid'] == pubnub.get_uuid() || 
                r['p2_uuid'] == pubnub.get_uuid())) {

                    if (r['mtype'] == 'handshake') {
                        switch(r['step']) {

                            case 1: // some one has asked us to play

                                if (r['p2_uuid'] == pubnub.get_uuid()) {
                                    var ok = confirm(r.p1_uuid + ' has requested to play with you. Are you game ?');
                                    if (ok) {
                                        start_handshake_2(r['p1_uuid'], r['turn']);
                                    }
                                }   
                                break;
                            case 2: // some has responded to our play request
                                if (r['p1_uuid'] == pubnub.get_uuid()) {
                                    alert(r.p2_uuid + ' accepted your request. GAME STARTED. Game ID : ' + r.game_id);
                                    games[r['game_id']] = {'map' : ['','','','','','','','',''], 'uuid' : r['p2_uuid']}
                                    console.log(JSON.stringify(games));
                                    start_handshake_3(r['p2_uuid'], r['turn']);
                                }
                                break;
                            case 3: // some one has confirmed the game
                                if (r['p2_uuid'] == pubnub.get_uuid()) {
                                    alert('GAME Confirmed with ' + r.p1_uuid + ' . Game ID : ' + r.game_id);
                                    games[r['game_id']] = {'map' : ['','','','','','','','',''], 'uuid' : r['p1_uuid']}
                                    console.log(JSON.stringify(games));
                                }
                                break;
                        }
                    }
                    if (r['mtype'] == 'game') {

                    }

            }
        },
        'error' : function(r) {

        },
        connect : function(r) {
            
        },
        presence : function(r) {
              /*$("#lobby table").append('<tr><td onclick="start_handshake(this.innerHTML, this.innerHTML);">'+r.uuid+'</td></tr>') */
              populate_lobby();
        }
    });
}

function game_step(position, game_id) {
    
}

function select_square(n) {
    document.getElementById(n).innerHTML = 'X';
}

function populate_lobby() {
    get_player_list(function(r){
            console.log(r);
            var array = r.uuids;
            var arrayLength = parseInt(array.length);
            $("#lobby table").empty();
            for (i=0; i<arrayLength; i++) {
                if (array[i] != pubnub.get_uuid()) {
                    $("#lobby table").append('<tr><td onclick="start_handshake(this.innerHTML, this.innerHTML);">'+array[i]+'</td></tr>');
                }
            }
            enter_lobby();
    })
}
function start() {
    $("#myuuid").append('<p> My UUID: ' + pubnub.get_uuid() + '</p>');
    populate_lobby();
}

</script>
<style type="text/css">

.square {
 background-color:white;
 font-size:1cm;
 width: 2cm;
 height: 2cm;
 vertical-align: center;
 text-align: center;
}


.grid {
 border: black;
 background-color:black;
}

</style>

</head>
<body onload="start()">
<table>
<tr>
    <td>
    <table align=center class=grid cellspacing=2>
    <tr>
     <td class=square id=1 onclick="select_square(this.id);"></td>
     <td class=square id=2 onclick="select_square(this.id);"></td>
     <td class=square id=3 onclick="select_square(this.id);"></td>
    </tr><tr>
     <td class=square id=4 onclick="select_square(this.id);"></td>
     <td class=square id=5 onclick="select_square(this.id);"></td>
     <td class=square id=6 onclick="select_square(this.id);"></td>
    </tr><tr>
     <td class=square id=7 onclick="select_square(this.id);"></td>
     <td class=square id=8 onclick="select_square(this.id);"></td>
     <td class=square id=9 onclick="select_square(this.id);"></td>
    </tr>
    </table>
    </td>
    <td>
    <div id='myuuid'><div>
    <div id="lobby">
        <p>LOBBY</p>
        <table align=center cellspacing=2>
        </table>
    </div>
    </td>
</tr>
</table>
</body>
</html>
