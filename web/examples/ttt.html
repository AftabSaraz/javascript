
<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html>
<head>
<style type="text/css">

.square {
 background-color:white;
 font-size:1cm;
 width: 2cm;
 height: 2cm;
 vertical-align: center;
 text-align: center;
}

.green {
    color: green;
    font-size: 24px;
}
.red {
    color : red;
    font-size: 24px;
}

.grid {
 border: black;
 background-color:black;
}

</style>

<title>Tic-Tac-Toe</title>
<script src="../pubnub.js"></script>
<script type="text/javascript">

var pubnub = PUBNUB({
    publish_key   : "pub-c-fd1a1d00-6c07-4435-a647-495cdfcdfc95",
    subscribe_key : "sub-c-f045aeaa-befe-11e3-b6e0-02ee2ddab7fe",
    uuid : PUBNUB.uuid(),
    leave_on_unload : true
});

</script>
<script src="./ttt.js"></script>
<script src="http://code.jquery.com/jquery-1.11.0.min.js"></script>.
<script type="text/javascript" language=javascript>



var games = {}


function start_handshake(uuid, turn) {
    var message = {
        'game' : 'tictactoe',
        'mtype' : 'handshake',
        'step' : 1,
        'p1_uuid' : pubnub.get_uuid(),
        'p2_uuid' : uuid,
        'turn' : turn
    };

    pubnub.publish({
        'channel' : get_lobby_channel(),
        'message' : message,
        'callback' : function(r) {debug_log(r)},
        'error' : function(r) {debug_log(r)}  
    });
}
function start_handshake_2(uuid, turn) {
    var message = {
        'game' : 'tictactoe',
        'mtype' : 'handshake',
        'step' : 2,
        'p1_uuid' : uuid,
        'turn' : turn,
        'p2_uuid' : pubnub.get_uuid(),
        'game_id' : getRandomInt(1,10000000000)
    };

    pubnub.publish({
        'channel' : get_lobby_channel(),
        'message' : message,
        'callback' : function(r) {debug_log(r)},
        'error' : function(r) {debug_log(r)}   
    });
}
function start_handshake_3(uuid, turn, game_id) {
    var message = {
        'game' : 'tictactoe',
        'mtype' : 'handshake',
        'step' : 3,
        'p1_uuid' : pubnub.get_uuid(),
        'p2_uuid' : uuid,
        'turn' : turn,
        'game_id' : game_id
    };

    pubnub.publish({
        'channel' : get_lobby_channel(),
        'message' : message,
        'callback' : function(r) {debug_log(r)},
        'error' : function(r) {debug_log(r)}  
    });
}

function clear_timers(game_id) {
    var game = games[game_id];
    if (game) {
        clearInterval(game['interval']);
        clearTimeout(game['timeout']);
        game['time_remaining'] = 30;
    }
}

function update_time_remaining(n) {
    $("#time").html('<p>'+n+' sec remaining</p>');
}

function update_turn(game_id, uuid) {

    var game = games[game_id];
    if (game) {

        $("#" + game_id + " #turn").html('<p>' + ((uuid == pubnub.get_uuid())?"Your ":"Opponent\'s") + ' turn</p>');

        $("#" + game_id + " #turn").removeClass((uuid == pubnub.get_uuid())?"red":"green");
        $("#" + game_id + " #turn").addClass((uuid == pubnub.get_uuid())?"green":"red");

        clear_timers(game_id);
        
        if (uuid == pubnub.get_uuid()) {
            game['timeout'] = setTimeout(function(){
                update_result('You lost');
                declare_winner((game['symbol'] == 'X')?'O':'X');
                clear_timers(game_id);
                $("#" + game_id + " #time").html('');
            }, 30000)
            game['interval'] = setInterval(function() {
                update_time_remaining(game['time_remaining']);
                game['time_remaining']--;
            }, 1000);

        } else {
            $("#" + game_id + " #time").html('');
        }
    }
}



function update_result(game_id, result) {
    clear_timers(game_id);
    $("#" + game_id + " #turn").empty();
    $("#" + game_id + " #result").html('<p>' + result + '</p>');
    $("#" + game_id + " #result").addClass((result == "You won")?"green":"red");
}

function update_my_uuid(game_id, uuid) {
    $("#" + game_id + " #my_uuid").html('<p> My UUID: ' + uuid + '</p>');
}

function update_opponent(game_id, uuid) {
    $("#" + game_id + " #opponent_uuid").html('<p> Opponent UUID: ' + uuid + '</p>');
}

function update_game_status(game_id, status) {
    $("#" + game_id + " #game").html('<p>' + status + '</p>');
}

function draw_grid(game_id, symbol, map) {
    for (var i in map) {
        $("#" + game_id + " #" + i).html(map[i]);
        
        if (symbol == map[i]) {
            $("#" + game_id + " #" + i).removeClass("red");
            $("#" + game_id + " #" + i).addClass("green");
        } else {
            $("#" + game_id + " #" + i).removeClass("green");
            $("#" + game_id + " #" + i).addClass("red");
        }
    }
}



function declare_winner(game_id, symbol) {
    var winner = '';
    var game = games[game_id];

    if (game) {
        if (symbol == game['symbol']) {
            winner = pubnub.get_uuid();
        } else {
            winner = game['uuid'];
        }
        var message = {
            'mtype' : 'winner',
            'game_id' : game_id,
            'winner' : winner
        }
        pubnub.publish({
            'channel' : game_id,
            'message' : message,
            'callback' : function(r){debug_log(JSON.stringify(r))},
            'error' : function(r){debug_log(JSON.stringify(r))}
        })
    }
}

function handle_game_messages(message) {

    if (message['mtype'] == 'game') {

        var gid_in_message = message['game_id'];
        var game = games[gid_in_message];

        if (game) {
            game['map'] = message['map'];

            draw_grid(gid_in_message, game['symbol'] , game['map']);

            game['turn'] = message['turn'];

            update_turn(gid_in_message, game['turn']);
            
            var winning_symbol = check_winner(game['map']);

            if (winning_symbol) {
                declare_winner(gid_in_message, winning_symbol);
            }
        }
        
    }
    if (message['mtype'] == 'winner') {
        if (games[message['game_id']]) {
            end_game(message['game_id'], message['winner']);
        }
    }

}

function get_game_id_from_cell(node) {
    return node.parentNode.parentNode.parentNode.parentNode.parentNode.id;
}


function select_cell(cell) {
    game_step(get_game_id_from_cell(cell), cell.id);
}

function create_grid(game_id) {
     $("#main").append("<tr></tr>");
     $("#main").append(
        '<tr id=' + game_id + '>'                                                               +
            '<td>'                                                                              +
                '<table align=center class=grid cellspacing=2>'                                 +
                    '<tr>'                                                                      +
                         '<td class=square id=0 onclick="select_cell(this);"></td>'             +
                         '<td class=square id=1 onclick="select_cell(this);"></td>'             +
                         '<td class=square id=2 onclick="select_cell(this);"></td>'             +
                    '</tr>'                                                                     +
                    '<tr>'                                                                      +
                         '<td class=square id=3 onclick="select_cell(this);"></td>'             +
                         '<td class=square id=4 onclick="select_cell(this);"></td>'             +
                         '<td class=square id=5 onclick="select_cell(this);"></td>'             +
                    '</tr>'                                                                     +
                    '<tr>'                                                                      +
                         '<td class=square id=6 onclick="select_cell(this);"></td>'             +
                         '<td class=square id=7 onclick="select_cell(this);"></td>'             +
                         '<td class=square id=8 onclick="select_cell(this);"></td>'             +
                    '</tr>'                                                                     +
                '</table>'                                                                      +
            '</td>'                                                                             +
            '<td>'                                                                              +
                '<div id="game"></div>'                                                         +
                '<div id="my_uuid"></div>'                                                       +
                '<div id="opponent_uuid"></div>'                                                +
                '<div id="turn"></div>'                                                         +
                '<div id="time"></div>'                                                         +
                '<div id="result"></div>'                                                       +
            '</td>'                                                                             +
        '</tr>'
    );

}


function create_game(game_id, opponent_uuid, my_symbol, turn_uuid) {
    games[game_id] = {
        'map'           : ['','','','','','','','',''],
        'uuid'          : opponent_uuid,
        'symbol'        : my_symbol,
        'turn'          : turn_uuid,
        'timeout'           : null,
        'interval'          : null,
        'time_remaining'    : 30
    };
    create_grid(game_id);
    update_opponent(game_id, opponent_uuid);
    update_my_uuid(game_id, pubnub.get_uuid());
    update_game_status(game_id, 'Game Started');
    update_turn(game_id, turn_uuid);
}

function end_game(game_id, winner_uuid) {
    update_game_status(game_id, 'finished');

    if (winner_uuid == pubnub.get_uuid()) {
        update_result(game_id, "You won");
    } else {
        update_result(game_id, "You lost");

    }
    delete games[game_id];
}

function enter_lobby() {
    pubnub.subscribe({
        'channel' : get_lobby_channel(),
        'callback' : function(r) {

            /* read message only if we are either player 1 or player 2 */

            if (r['game'] == 'tictactoe' && 
                (r['p1_uuid'] == pubnub.get_uuid() || 
                r['p2_uuid'] == pubnub.get_uuid())) {

                    // handle handshakes
                    if (r['mtype'] == 'handshake') {
                        switch(r['step']) {

                            case 1: // some one has asked us to play

                                if (r['p2_uuid'] == pubnub.get_uuid()) { // we are player 2, send handshake
                                    start_handshake_2(r['p1_uuid'], r['turn']);
                                }   
                                break;

                            case 2: // some has responded to our play request

                                if (r['p1_uuid'] == pubnub.get_uuid()) { // we are player 1, we send initial request

                                    // leave lobby. we might want to remove this in case playing multiple games
                                    // at same time is going to be supported later on.
                                    //pubnub.unsubscribe({channel : get_lobby_channel()}); 
                                    
                                    // create a private channel to play the game.
                                    pubnub.subscribe({
                                        'channel' : r['game_id'],
                                        'callback' : function(r1) {
                                            handle_game_messages(r1);
                                        },
                                        'error' : function(r1) {

                                        },
                                        'connect' : function(r1) {

                                            // send handshake 3 to acknowledge that we are starting

                                            start_handshake_3(r['p2_uuid'], r['turn'], r['game_id']);
                                    
                                            create_game(r['game_id'], r['p2_uuid'], 'X', r['turn']);

                                        }
                                    });
                                }
                                break;

                            case 3: // some one has confirmed the game

                                if (r['p2_uuid'] == pubnub.get_uuid()) { // we are player 2, player 1 has confirmed 

                                    // leave lobby. we might want to remove this in case playing multiple games
                                    // at same time is going to be supported later on.                                    
                                    //pubnub.unsubscribe({channel : get_lobby_channel()});

                                    pubnub.subscribe({
                                        'channel' : r['game_id'],
                                        'callback' : function(r1) {
                                            handle_game_messages(r1);
                                        },
                                        'error' : function(r1) {

                                        },
                                        'connect' : function(r1) {

                                            create_game(r['game_id'], r['p1_uuid'], 'O', r['turn']);

                                        }
                                    });
                                }
                                break;
                        }
                    }

            }
        },
        'error' : function(r) {

        },
        connect : function(r) {
            /*
            pubnub.here_now({
                'channel' : get_lobby_channel(),
                'callback' : function(r) {
                    var uuids = r.uuids;
                    var i = getRandomInt(0,uuids.length - 1);
                    var count = 0;
                    while(uuids[i] != pubnub.get_uuid() && uuids.length > 1 && count < 4) {
                        i = getRandomInt(0, uuids.length - 1);
                        count++;
                    }
                    start_handshake(uuids[i], uuids[i]);
                },
                'error' : function (r) {

                }
            });
*/
            
        },
        presence : function(r) {
              /*$("#lobby table").append('<tr><td onclick="start_handshake(this.innerHTML, this.innerHTML);">'+r.uuid+'</td></tr>') */
            /*
            if (r.action == 'join' && r.uuid != pubnub.get_uuid()) {
                start_handshake(r.uuid , r.uuid);
            }
            */
        }
    });
}

function game_step(game_id, position) {

    var game = games[game_id];
    if (game) {
        if (game['map'][position] == '' && game['turn'] == pubnub.get_uuid()) {
            
            var m = [];

            for ( var i in game['map']) {
                m[i] = game['map'][i];
            }
            m[position] = game['symbol'];
            var message = {
                'mtype' : 'game',
                'game_id' : game_id,
                'map' : m,
                'turn' : game['uuid']
            }
            pubnub.publish({
                'channel' : game_id,
                'message' : message,
                'callback' : function(r){try {game['map'][position] = 'X';} catch (e) {}debug_log(JSON.stringify(r))},
                'error' : function(r){debug_log(JSON.stringify(r))}
            })
        }
    }
}


function populate_lobby() {
    get_player_list(function(r){
            debug_log(r);
            var array = r.uuids;
            var arrayLength = parseInt(array.length);
            $("#lobby table").empty();
            for (i=0; i<arrayLength; i++) {
                if (array[i] != pubnub.get_uuid()) {
                    $("#lobby table").append('<tr><td onclick="start_handshake(this.innerHTML, this.innerHTML);">'+array[i]+'</td></tr>');
                }
            }
            enter_lobby();
    })
}
function start() {
    populate_lobby();
}

</script>

</head>
<body onload="start()">
<table id="main">
</table>
<div id=lobby>
<table>
</table>
</div>
</body>
</html>
